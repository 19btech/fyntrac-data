name: Run Functional Tests

permissions:
  contents: read
  packages: read

on:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Run remote tests via SSH
        id: ssh_run
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 72.60.172.224
          username: root
          password: Funrun21@19b
          timeout: 1800         # Timeout in seconds (30 minutes)
          script: |
            cd ~/Workspace/fyntrac-data
            chmod +x run_tests.sh
            ./run_tests.sh

      - name: Check test results and fail if any test failed
        if: ${{ always() }}
        run: |
          echo "========== Full run_tests.sh output =========="
          echo "${{ steps.ssh_run.outputs.stdout }}"

          echo
          echo "========== Test Summary Section =========="
          echo "${{ steps.ssh_run.outputs.stdout }}" | sed -n '/^=\\{20\\} TEST SUMMARY =\\{20\\}$/,/^=\\{20\\}$/p' || echo "Summary section not found"

          # Fail if any test failed
          if echo "${{ steps.ssh_run.outputs.stdout }}" | grep -qP '\tFAILED\b'; then
            echo "❌ One or more tests failed."
            exit 1
          else
            echo "✅ All tests passed."
          fi
